<?php

/**
 * @file
 * Smalk module for AI Agent Tracking and AI Search Ads.
 *
 * This module provides:
 * 1. JavaScript tracker injection for frontend analytics
 * 2. Server-side tracking for AI Agent detection
 * 3. Server-side AI Search Ads injection into pages
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function smalk_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.smalk':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Smalk module provides complete GEO (Generative Engine Optimization) integration including:') . '</p>';
      $output .= '<ul>';
      $output .= '<li>' . t('<strong>JavaScript Tracker</strong>: Automatically adds the Smalk tracker script to all pages for frontend analytics.') . '</li>';
      $output .= '<li>' . t('<strong>Server-Side Tracking</strong>: Tracks all page visits including AI Agents that don\'t execute JavaScript.') . '</li>';
      $output .= '<li>' . t('<strong>AI Search Ads</strong>: Server-side injection of contextual ads into &lt;div smalk-ads&gt;&lt;/div&gt; elements.') . '</li>';
      $output .= '</ul>';
      $output .= '<h3>' . t('Configuration') . '</h3>';
      $output .= '<p>' . t('Configure the module at <a href=":settings">Administration &gt; Configuration &gt; Web services &gt; Smalk</a>.', [':settings' => '/admin/config/services/smalk']) . '</p>';
      $output .= '<h3>' . t('Usage') . '</h3>';
      $output .= '<p>' . t('For ad placements, add the following HTML to your templates or content:') . '</p>';
      $output .= '<pre>&lt;div smalk-ads&gt;&lt;/div&gt;</pre>';
      $output .= '<p>' . t('For multiple placements on the same page, add unique IDs:') . '</p>';
      $output .= '<pre>&lt;div smalk-ads id="header-ad"&gt;&lt;/div&gt;
&lt;div smalk-ads id="sidebar-ad"&gt;&lt;/div&gt;</pre>';
      return $output;
  }
}

/**
 * Implements hook_filter_info_alter().
 *
 * This allows us to modify filter definitions, but for Drupal 9/10/11,
 * we need to use a plugin approach or configure text formats manually.
 */
function smalk_filter_info_alter(&$info) {
  // Note: In Drupal 9+, filters are plugins, so this hook has limited effect.
  // Users need to configure their text format to allow the smalk-ads attribute.
  // See README.md for instructions.
}

/**
 * Implements hook_ckeditor5_plugin_info_alter().
 *
 * Adds smalk-ads attribute to existing CKEditor5 div plugin for Drupal 10.
 */
function smalk_ckeditor5_plugin_info_alter(array &$plugin_definitions) {
  // Find the core htmlDiv plugin and add smalk-ads to allowed elements.
  if (isset($plugin_definitions['ckeditor5_htmlSupport'])) {
    /** @var \Drupal\ckeditor5\Plugin\CKEditor5PluginDefinition $plugin */
    $plugin = $plugin_definitions['ckeditor5_htmlSupport'];
    $definition = $plugin->toArray();
    
    // Add <div smalk-ads> and <div smalk-ads id> to allowed elements if not already there.
    $elements = $definition['drupal']['elements'] ?? [];
    $needs_update = FALSE;
    
    if (!in_array('<div smalk-ads>', $elements)) {
      $elements[] = '<div smalk-ads>';
      $needs_update = TRUE;
    }
    if (!in_array('<div smalk-ads id>', $elements)) {
      $elements[] = '<div smalk-ads id>';
      $needs_update = TRUE;
    }
    
    if ($needs_update) {
      $definition['drupal']['elements'] = $elements;
      $plugin_definitions['ckeditor5_htmlSupport'] = new \Drupal\ckeditor5\Plugin\CKEditor5PluginDefinition($definition);
    }
  }
}

/**
 * Implements hook_page_attachments().
 *
 * Adds the Smalk JavaScript tracker to all pages.
 */
function smalk_page_attachments(array &$attachments) {
  $config = \Drupal::config('smalk.settings');
  
  // Check if module is enabled
  if (!$config->get('enabled')) {
    return;
  }
  
  // Check if tracking is enabled
  if (!$config->get('tracking_enabled')) {
    return;
  }
  
  $workspace_key = $config->get('workspace_key');
  if (empty($workspace_key)) {
    return;
  }
  
  // Skip admin pages if configured
  if ($config->get('exclude_admin_pages')) {
    $route = \Drupal::routeMatch()->getRouteObject();
    if ($route && $route->getOption('_admin_route')) {
      return;
    }
  }
  
  // Add the Smalk tracker script
  $tracker_url = \Drupal\smalk\Api\SmalkApi::getTrackerJsUrl();
  $attachments['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'script',
      '#attributes' => [
        'src' => $tracker_url . '?PROJECT_KEY=' . $workspace_key,
        'async' => TRUE,
      ],
    ],
    'smalk_tracker_script',
  ];
}
